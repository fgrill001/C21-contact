<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Digital Business Card</title>
<link rel="manifest" href="./manifest.webmanifest"/>
<link rel="apple-touch-icon" href="./apple-touch-icon.png"/>
<meta name="theme-color" content="#111111"/>
<style>
:root{--gold:#BEAF87;--bg:#0f0f10;--panel:#161616;--border:#2a2a2a;--text:#fff;--muted:#9a9a9a}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
.wrap{max-width:560px;margin:0 auto;padding:16px}
.card{background:var(--panel);border:1px solid var(--border);border-radius:16px;overflow:hidden;box-shadow:0 12px 36px rgba(0,0,0,.35)}
.brandbar{display:flex;gap:12px;align-items:center;padding:14px 16px;background:#121212;border-bottom:1px solid var(--border)}
.badge{width:48px;height:48px;border-radius:12px;background:var(--gold);display:grid;place-items:center;color:#111;font-weight:900;text-align:center;line-height:1}
.section{padding:14px 16px;border-top:1px solid var(--border)}
.hint{font-size:12px;color:var(--muted);margin-top:6px}
.footer{text-align:center;font-size:11px;color:#777;padding:12px}
.row{display:flex;gap:10px;margin-top:10px}
.btn{
  flex:1;display:flex;justify-content:center;align-items:center;gap:8px;
  padding:12px;border-radius:12px;font-weight:700;text-decoration:none;cursor:pointer;
  border:1px solid transparent;line-height:1.2;white-space:nowrap
}
.btn + .btn{margin-top:10px}
.primary{background:var(--gold);color:#111}
.secondary{background:#232323;color:#fff;border-color:#333}
.tertiary{background:#1b1b1b;color:#fff;border:1px dashed #333}

.header{display:flex;gap:12px;align-items:center}
.avatar{width:64px;height:64px;border-radius:50%;border:2px solid var(--gold);background:#0f0f0f;background-size:cover;background-position:center;display:inline-grid;place-items:center;color:var(--gold);font-weight:800;font-size:20px}
.name{font-weight:900;color:var(--gold);font-size:20px}
.small{font-size:13px;color:#9a9a9a}
hr.sep{border:0;border-top:1px solid var(--border);margin:10px 0}

/* Minimal chooser */
.list{max-height:60vh;overflow:auto;border:1px solid #2a2a2a;border-radius:12px}
.item{padding:12px 14px;border-bottom:1px solid #222;display:flex;gap:12px;align-items:center;cursor:pointer}
.item:last-child{border-bottom:0}
.item:hover{background:#1d1d1d}
.thumb{width:40px;height:40px;border-radius:50%;background:#0f0f0f;border:1px solid #333;background-size:cover;background-position:center;display:grid;place-items:center;color:#BEAF87;font-weight:800}
.hidden{display:none !important}
</style>

<script>
/* Supabase config */
window.CONFIG = {
  SUPABASE_URL: "https://sqkypvsorvhzpksswdus.supabase.co",
  SUPABASE_ANON: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNxa3lwdnNvcnZoenBrc3N3ZHVzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzNzU3ODIsImV4cCI6MjA3MTk1MTc4Mn0.DAIFf8mhhAFq6iUa5I-QyqP6-OPnM0PhX9uLkY-1JK4"
};
/* FH website + office */
const FH_WEBSITE = "https://www.century21.pt/agencias/forever-homes";
const FH_OFFICE  = "https://www.google.com/maps?q=Estrada+Do+Farol+84,+8400-505+Carvoeiro,+Portugal";

/* Storage key to remember last consultant */
const LAST_ID_KEY = "client_last_id";
</script>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="brandbar">
      <div class="badge">Your<br/>C21</div>
      <div>
        <b id="titleLine">Digital Business Card</b>
        <div class="small">Make Home Better</div>
      </div>
    </div>

    <!-- CHOOSER (only shows when no id known) -->
    <div id="chooseView" class="section hidden">
      <h3 style="margin:0 0 10px">Select your consultant</h3>
      <div id="list" class="list"></div>
      <div class="hint" style="margin-top:10px">Tip: next time, save this to your Home Screen after opening your consultant‚Äôs card.</div>
    </div>

    <!-- CARD VIEW -->
    <div id="cardView" class="hidden">
      <div class="section">
        <div class="header">
          <div id="avatar" class="avatar">--</div>
          <div>
            <div id="name" class="name">Consultant</div>
            <div id="email" class="small">email@example.com</div>
            <div id="phone" class="small">+351 ‚Ä¶</div>
          </div>
        </div>
      </div>

      <div class="section">
        <a class="btn primary"   id="saveVCF"  download="contact.vcf">üßæ Save Contact</a>
        <a class="btn secondary" id="waBtn"    target="_blank" rel="noopener">üí¨ WhatsApp</a>
        <a class="btn secondary" id="callBtn">üìû Call</a>
        <a class="btn secondary" id="smsBtn">üì± Text</a>
        <div class="row">
          <a class="btn secondary" id="emailBtn">‚úâÔ∏è Email</a>
          <a class="btn tertiary"  id="copyLinkBtn">üîó Copy Link</a>
        </div>
        <hr class="sep"/>
        <a class="btn secondary" id="fhOffice" target="_blank" rel="noopener">üìç Find FH Office</a>
        <a class="btn secondary" id="fhSite"   target="_blank" rel="noopener">üè† Visit FH Website</a>
      </div>

      <div class="section">
        <div class="hint">
          To save this card: <br/>
          üì± iPhone ‚Äî hit Share ‚Üí Add to Home Screen <br/>
          ü§ñ Android ‚Äî hit ‚ãÆ ‚Üí Add to Home screen
        </div>
      </div>

      <div class="footer">¬© 2025 Century 21 Forever Homes ‚Ä¢ Powered by 2F</div>
    </div>
  </div>
</div>

<script>
if("serviceWorker" in navigator){ navigator.serviceWorker.register("./sw.js"); }

const $=id=>document.getElementById(id);
const enc=s=>encodeURIComponent(s);

function showChoose(){ $("chooseView").classList.remove("hidden"); $("cardView").classList.add("hidden"); }
function showCard(){ $("chooseView").classList.add("hidden"); $("cardView").classList.remove("hidden"); }

async function fetchSupabaseAll(){
  const {SUPABASE_URL,SUPABASE_ANON}=window.CONFIG||{};
  if(!SUPABASE_URL||!SUPABASE_ANON) return [];
  try{
    const res=await fetch(`${SUPABASE_URL}/rest/v1/consultants?select=id,name,email,phone,card_link,avatar`,{
      headers:{apikey:SUPABASE_ANON, Authorization:"Bearer "+SUPABASE_ANON}
    });
    if(!res.ok) return [];
    return await res.json();
  }catch{ return []; }
}
async function fetchLocalAll(){
  try{
    const r=await fetch("./data/consultants.json");
    if(!r.ok) return [];
    const j=await r.json();
    return j.consultants||[];
  }catch{ return []; }
}

async function loadProfileById(id){
  // Supabase first
  try{
    const {SUPABASE_URL,SUPABASE_ANON}=window.CONFIG||{};
    if(SUPABASE_URL && SUPABASE_ANON && id){
      const res=await fetch(`${SUPABASE_URL}/rest/v1/consultants?id=eq.${encodeURIComponent(id)}&select=id,name,email,phone,card_link,avatar`,{
        headers:{apikey:SUPABASE_ANON, Authorization:"Bearer "+SUPABASE_ANON}
      });
      if(res.ok){
        const rows=await res.json();
        if(rows[0]) return rows[0];
      }
    }
  }catch(e){}
  // Fallback local
  try{
    const r=await fetch("./data/consultants.json");
    if(r.ok){
      const j=await r.json();
      return (j.consultants||[]).find(c=>c.id===id) || null;
    }
  }catch(e){}
  return null;
}

function renderProfile(p){
  document.title = `${p.name || "Consultant"} ‚Äî Digital Business Card`;
  $("titleLine").textContent = `${p.name || "Consultant"} ‚Äî Digital Business Card`;
  $("name").textContent = p.name || "";
  $("email").textContent = p.email || "";
  $("phone").textContent = p.phone || "";

  const av = (p.avatar||"").trim();
  if(av){
    if(/^https?:\/\//i.test(av)){
      $("avatar").style.backgroundImage = `url(${av})`;
      $("avatar").textContent = "";
    }else{
      const path = av.startsWith("./") ? av : ("./"+av);
      $("avatar").style.backgroundImage = `url(${path})`;
      $("avatar").textContent = "";
    }
  }else{
    const ini = (p.name||"").split(/\s+/).map(s=>s[0]).join("").slice(0,2).toUpperCase() || "--";
    $("avatar").textContent = ini;
  }

  const myUrl = location.origin + location.pathname + "?id=" + encodeURIComponent(p.id);

  $("fhSite").href   = FH_WEBSITE;
  $("fhOffice").href = FH_OFFICE;

  $("waBtn").href   = `https://wa.me/${(p.phone||"").replace(/\D/g,"")}?text=${enc("Here is my digital business card: "+myUrl)}`;
  $("callBtn").href = p.phone ? `tel:${p.phone.replace(/\s+/g,"")}` : "#";
  $("smsBtn").href  = p.phone ? `sms:${p.phone.replace(/\s+/g,"")}?&body=${enc("Here is my digital business card: "+myUrl)}` : "#";
  $("emailBtn").href= `mailto:${p.email||""}?subject=${enc("My digital business card")}&body=${enc("Hi,\n\nHere is my digital business card: "+myUrl)}`;

  $("copyLinkBtn").onclick = async ()=>{ try{ await navigator.clipboard.writeText(myUrl); alert("Link copied"); }catch{ alert("Copy failed"); } };

  const vcf = [
    "BEGIN:VCARD","VERSION:3.0",
    `FN:${(p.name||"").replace(/\r?\n/g,"\\n")}`,
    p.email ? `EMAIL;TYPE=INTERNET:${p.email}` : null,
    p.phone ? `TEL;TYPE=CELL:${p.phone}` : null,
    "ORG:Century 21 Forever Homes",
    FH_WEBSITE ? `URL:${FH_WEBSITE}` : null,
    "END:VCARD"
  ].filter(Boolean).join("\r\n");
  const blob = new Blob([vcf], {type:"text/vcard"});
  $("saveVCF").href = URL.createObjectURL(blob);
  $("saveVCF").download = (p.name || "contact").replace(/\s+/g,"_") + ".vcf";
}

async function renderChooser(){
  // Load list from Supabase or local
  let rows = await fetchSupabaseAll();
  if(!rows.length) rows = await fetchLocalAll();
  rows.sort((a,b)=> (a.name||"").localeCompare(b.name||""));

  const list=$("list"); list.innerHTML="";
  rows.forEach(c=>{
    const li=document.createElement("div"); li.className="item";
    const t=document.createElement("div"); t.className="thumb";
    if(c.avatar && !c.avatar.startsWith("http") && !c.avatar.startsWith("./")) c.avatar="./"+c.avatar;
    if(c.avatar){ t.style.backgroundImage=`url(${c.avatar})`; t.textContent=""; }
    else { t.textContent=(c.name||"--").slice(0,2).toUpperCase(); }
    const info=document.createElement("div");
    info.innerHTML = `<div style="font-weight:700">${c.name||""}</div><div class="small">${c.email||""}</div>`;
    li.appendChild(t); li.appendChild(info);
    li.onclick = async ()=>{
      localStorage.setItem(LAST_ID_KEY, c.id);
      const p = await loadProfileById(c.id);
      if(p){ renderProfile(p); showCard(); }
      else { alert("Could not load consultant. Please try again."); }
    };
    list.appendChild(li);
  });

  showChoose();
}

(async function init(){
  const params = new URLSearchParams(location.search);
  const incomingId = params.get("id");
  if (incomingId) localStorage.setItem(LAST_ID_KEY, incomingId);
  const id = incomingId || localStorage.getItem(LAST_ID_KEY);

  if(!id){
    // No id anywhere ‚Üí show minimal chooser
    await renderChooser();
    return;
  }

  const profile = await loadProfileById(id);
  if(!profile){
    // If lookup fails (e.g., storage mismatch), show chooser
    await renderChooser();
    return;
  }

  renderProfile(profile);
  showCard();
})();
</script>
</body>
</html>
